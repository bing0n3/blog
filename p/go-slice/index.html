<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Go中Slice的总结 - bing0ne Base</title><meta name=description content=在刷leetcode的78题的时候，遇到了对slice的append的bug。><meta name=author content=bing0ne><link href=https://blog.bing0ne.com/an-old-hope.min.css rel=stylesheet><link href=https://blog.bing0ne.com/style.css rel=stylesheet><link rel=apple-touch-icon href=https://blog.bing0ne.com/apple-touch-icon.png><link rel=icon href=https://blog.bing0ne.com/favicon.ico><meta name=generator content="Hugo 0.58.2"><link rel=alternate type=application/atom+xml href=https://blog.bing0ne.com/index.xml title="bing0ne Base"><meta property=og:title content=Go中Slice的总结><meta property=og:description content=在刷leetcode的78题的时候，遇到了对slice进行append的bug。><meta property=og:type content=article><meta property=og:url content=https://blog.bing0ne.com/p/go-slice/><meta property=article:published_time content=2019-01-30T12:31:04-05:00><meta property=article:modified_time content=2019-01-30T12:31:04-05:00></head><body class=single><header class=header><nav class=nav><p class=logo><a href=https://blog.bing0ne.com>bing0ne Base</a></p><ul class=menu><li><a href=https://blog.bing0ne.com/>Home</a></li><li><a href=https://blog.bing0ne.com/categories/dev/>Dev</a></li><li><a href=https://blog.bing0ne.com/categories/eassy/>Eassy</a></li><li><a href=https://blog.bing0ne.com/categories/gsoc/>GSoC</a></li><li><a href=https://blog.bing0ne.com/tags/>Tags</a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Go中Slice的总结</h1><div class=post-meta>bing0ne · January 30, 2019</div></header><div class=post-content><p>在刷leetcode的78题的时候，遇到了对slice的append的bug。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>subsets</span>(<span style=color:#a6e22e>nums</span> []<span style=color:#66d9ef>int</span>) [][]<span style=color:#66d9ef>int</span> {
    <span style=color:#a6e22e>ans</span> <span style=color:#f92672>:=</span> [][]<span style=color:#66d9ef>int</span>{[]<span style=color:#66d9ef>int</span>{}}

	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>nums</span> {
		<span style=color:#a6e22e>newSets</span> <span style=color:#f92672>:=</span> make([][]<span style=color:#66d9ef>int</span>, <span style=color:#ae81ff>0</span>)
		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>set</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ans</span> {
			<span style=color:#a6e22e>tmp</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>int</span>, len(<span style=color:#a6e22e>set</span>)<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
          <span style=color:#a6e22e>tmp</span> = append(<span style=color:#a6e22e>set</span>,<span style=color:#a6e22e>n</span>)
          <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%v\n&#34;</span>,<span style=color:#a6e22e>ans</span>)
          <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%d, %v, 变量的地址: %p, %v \n&#34;</span>, <span style=color:#a6e22e>n</span>,<span style=color:#a6e22e>set</span>,<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>set</span>, <span style=color:#a6e22e>tmp</span>)
			<span style=color:#a6e22e>newSets</span> = append(<span style=color:#a6e22e>newSets</span>, <span style=color:#a6e22e>tmp</span>)
		}
		<span style=color:#a6e22e>ans</span> = append(<span style=color:#a6e22e>ans</span>, <span style=color:#a6e22e>newSets</span><span style=color:#f92672>...</span>)
	}
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ans</span>
}</code></pre></div><p>我们发现<code>[9,0,3]</code>和<code>[9,0,3,5]</code>共享一个底层数组, 当我们向<code>[9,0,3]</code> <code>append</code>一个7的时候，我们会覆盖<code>[9,0,3,5]</code>中的5，变为<code>[9,0,3,7]</code>。为了解决这个问题我们需要使用<code>copy</code>，为每一个append后的切片创建一个新的数组。</p><pre><code>copy(tmp, append(set, n))
</code></pre><h2 id=关于slice>关于Slice</h2><p>那么为什么会造成这个上面的这个bug呢？ 这和go中<code>slice</code>和<code>append</code>的性质都有关。 在<strong>Go中数组是一个值</strong>，而不是像在C中的那样是一个指向第一个元素的指针。而<code>slice</code>在一定程度上更像C中的数组，<code>slice</code>是对一个数组片段的描述，它由指向数组的指针，长度(length)和容量(capacity)构成。同时切片化的操作，就是创建一个指向原数组的新的切片值。</p><h2 id=关于append>关于Append</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> append(<span style=color:#a6e22e>slice</span> []<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>elems</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>Type</span>) []<span style=color:#a6e22e>Type</span></code></pre></div><p><code>append</code>， 当空间(capacity)足够时候，会直接加在slice的尾部，这时候如果slice指向的数组是一个空间足够的数组的，会直接在slice的末尾，覆盖原数组中的数(e.g. a [1,2,3,4];slice 取 [0,1] ,增加一个1，则原数组会变为[1,2,1,3]) 或者增加一个数。如果空间不够的情况下，我们会重新分配一个数组。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>a</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>int</span>{<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>8</span>}
<span style=color:#a6e22e>b</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>int</span>{<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>8</span>}

<span style=color:#a6e22e>slice</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>a</span>[<span style=color:#ae81ff>0</span>:<span style=color:#ae81ff>2</span>]
<span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> append(<span style=color:#a6e22e>slice</span>, <span style=color:#ae81ff>1</span>)

<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>a</span>)
<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>b</span>)
<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>d</span>)

<span style=color:#75715e>/* output
</span><span style=color:#75715e>[1 2 1 4 5 6 7 8]
</span><span style=color:#75715e>[1 2 3 4 5 6 7 8]
</span><span style=color:#75715e>[1 2 1]
</span><span style=color:#75715e>*/</span></code></pre></div><h2 id=关于for-range>关于For Range</h2><p>关于<code>for range</code>,则是意外的收获， 我们发现在<code>For-range</code>会使用同一块内存去接收循环中的值。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>h</span> <span style=color:#f92672>:=</span> [][]<span style=color:#66d9ef>int</span>{[]<span style=color:#66d9ef>int</span>{}}
<span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> [][]<span style=color:#66d9ef>int</span>{[]<span style=color:#66d9ef>int</span>{<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>}, []<span style=color:#66d9ef>int</span>{<span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>7</span>}}

<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>z</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>f</span> {
	<span style=color:#a6e22e>tmp</span> <span style=color:#f92672>:=</span> append(<span style=color:#a6e22e>z</span>, <span style=color:#a6e22e>i</span>)
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;变量的地址: %p\n&#34;</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>z</span>)
	<span style=color:#a6e22e>h</span> = append(<span style=color:#a6e22e>h</span>, <span style=color:#a6e22e>tmp</span>)
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>tmp</span>)
}

<span style=color:#75715e>/*
</span><span style=color:#75715e>output:
</span><span style=color:#75715e>变量的地址: 0xc00000a0e0
</span><span style=color:#75715e>变量的地址: 0xc00000a0e0
</span><span style=color:#75715e>*/</span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.bing0ne.com/tags/go>go</a></li></ul></footer><div id=disqus_thread></div><script>var disqus_shortname='bing0ne';(function(){var d=document,s=d.createElement('script');s.src='https://'+disqus_shortname+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></article></main><footer class=footer><span>&copy; 2019 <a href=https://blog.bing0ne.com>bing0ne Base</a></span>
<span>&middot;</span>
<span>Powered by <a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>️</span>
<span>&middot;</span>
<span>Theme️ <a href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>Paper</a></span></footer><script src=https://blog.bing0ne.com/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>